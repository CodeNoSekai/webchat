<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ConnectSphere - Connect Device</title>

		<!-- Tailwind CSS CDN -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- Google Fonts: Fira Sans -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;500;700&display=swap"
			rel="stylesheet"
		/>

		<!-- intl-tel-input (for phone number with flags) CDN -->
		<link
			rel="stylesheet"
			href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/css/intlTelInput.css"
		/>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/intlTelInput.min.js"></script>

		<style>
			body {
				font-family: "Fira Sans", sans-serif;
			}
			.iti {
				width: 100%;
			}
			.iti__country-list {
				border-radius: 0.5rem;
				box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
			}
			input[type="number"]::-webkit-inner-spin-button,
			input[type="number"]::-webkit-outer-spin-button {
				-webkit-appearance: none;
				margin: 0;
			}
			input[type="number"] {
				appearance: textfield;
			}
		</style>
	</head>
	<body class="bg-gray-50">
		<div class="flex items-center justify-center min-h-screen p-4">
			<div
				class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-lg p-8 text-center"
			>
				<div class="flex justify-center mb-4">
					<div
						class="w-16 h-16 bg-teal-500 rounded-full flex items-center justify-center"
					>
						<svg
							xmlns="http://www.w3.org/2000/svg"
							class="h-8 w-8 text-white"
							fill="none"
							viewBox="0 0 24 24"
							stroke="currentColor"
							stroke-width="2"
						>
							<path
								stroke-linecap="round"
								stroke-linejoin="round"
								d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"
							/>
						</svg>
					</div>
				</div>

				<h1 class="text-3xl font-bold text-gray-800 mb-2">Connect a New Device</h1>
				<p class="text-gray-500 mb-8">
					Enter your phone number to receive a pairing code.
				</p>

				<form id="pair-form" class="space-y-6">
					<div>
						<label for="phone" class="sr-only">Phone number</label>
						<input id="phone" name="phone" type="tel" required class="w-full" />
					</div>

					<div>
						<button
							type="submit"
							class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-teal-500 hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out"
						>
							Connect Device
						</button>
					</div>
				</form>

				<div id="pairing-section" class="hidden mt-8 p-4 bg-gray-100 rounded-lg">
					<p class="text-gray-600 mb-2">
						Open WhatsApp on your main phone and enter this code:
					</p>
					<p
						id="pairing-code"
						class="text-3xl font-bold text-teal-600 tracking-widest"
					></p>
				</div>

				<div id="message-area" class="mt-4 text-sm text-gray-500"></div>

				<p class="mt-8 text-xs text-gray-400">
					Use this service to link a companion device. Your account will remain on
					your primary phone.
				</p>
			</div>
		</div>

		<script>
			const phoneInputField = document.querySelector("#phone");
			const phoneInput = window.intlTelInput(phoneInputField, {
				initialCountry: "auto",
				geoIpLookup: function (callback) {
					fetch("https://ipapi.co/json")
						.then(res => res.json())
						.then(data => callback(data.country_code))
						.catch(() => callback("us"));
				},
				utilsScript:
					"https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.13/js/utils.js",
			});

			const pairForm = document.getElementById("pair-form");
			const messageArea = document.getElementById("message-area");
			const pairingSection = document.getElementById("pairing-section");
			const pairingCodeDisplay = document.getElementById("pairing-code");

			// Check for existing session
			const savedPhone = localStorage.getItem("whatsapp_phone");
			if (savedPhone) {
				messageArea.textContent = "Existing session found. Connecting...";
				const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
				const ws = new WebSocket(
					`${wsProtocol}//${window.location.host}/chat/${savedPhone}`
				);

				ws.onopen = () => {
					ws.send(JSON.stringify({ type: "register", phone: savedPhone }));
					fetch("/pair", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ phone: savedPhone }),
					})
						.then(response => {
							if (!response.ok) {
								throw new Error("Server responded with an error.");
							}
						})
						.catch(error => {
							console.error("Session check failed:", error);
							localStorage.removeItem("whatsapp_phone");
							messageArea.textContent = "Session invalid. Please connect again.";
							messageArea.classList.add("text-red-500");
						});
				};

				ws.onmessage = event => {
					try {
						const message = JSON.parse(event.data);
						if (message.type === "connection-ready") {
							messageArea.textContent = "Session active. Redirecting to chat...";
							setTimeout(() => {
								window.location.href = "/chat";
							}, 1000);
						} else if (message.type === "error") {
							localStorage.removeItem("whatsapp_phone");
							messageArea.textContent = message.message;
							messageArea.classList.add("text-red-500");
						}
					} catch (error) {
						localStorage.removeItem("whatsapp_phone");
						messageArea.textContent = "Invalid response from server.";
						messageArea.classList.add("text-red-500");
					}
				};

				ws.onerror = () => {
					localStorage.removeItem("whatsapp_phone");
					messageArea.textContent = "Failed to connect. Please try again.";
					messageArea.classList.add("text-red-500");
				};
			}

			pairForm.addEventListener("submit", async event => {
				event.preventDefault();

				if (!phoneInput.isValidNumber()) {
					messageArea.textContent = "Please enter a valid phone number.";
					messageArea.classList.add("text-red-500");
					return;
				}

				const phoneNumber = phoneInput.getNumber().replace(/\D/g, "");
				messageArea.textContent = "Requesting pairing code...";
				messageArea.classList.remove("text-red-500");
				pairingSection.classList.add("hidden");

				localStorage.setItem("whatsapp_phone", phoneNumber);
				const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
				const ws = new WebSocket(
					`${wsProtocol}//${window.location.host}/chat/${phoneNumber}`
				);

				ws.onopen = () => {
					ws.send(JSON.stringify({ type: "register", phone: phoneNumber }));
					fetch("/pair", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ phone: phoneNumber }),
					})
						.then(response => {
							if (!response.ok) {
								throw new Error("Server responded with an error.");
							}
							messageArea.textContent = "Connection established. Waiting for code...";
						})
						.catch(error => {
							console.error("Pairing request failed:", error);
							messageArea.textContent = "Failed to start pairing. Please try again.";
							messageArea.classList.add("text-red-500");
							localStorage.removeItem("whatsapp_phone");
							ws.close();
						});
				};

				ws.onmessage = event => {
					try {
						const message = JSON.parse(event.data);
						switch (message.type) {
							case "pairing-code":
								pairingCodeDisplay.textContent = message.code;
								pairingSection.classList.remove("hidden");
								messageArea.textContent = "";
								pairForm.classList.add("hidden");
								break;
							case "connection-ready":
								messageArea.textContent = "Connection successful! Redirecting...";
								setTimeout(() => {
									window.location.href = "/chat";
								}, 1000);
								break;
							case "error":
								messageArea.textContent = message.message;
								messageArea.classList.add("text-red-500");
								localStorage.removeItem("whatsapp_phone");
								break;
						}
					} catch (error) {
						console.error("Failed to parse message from server:", error);
						messageArea.textContent = "Received an invalid message from the server.";
						messageArea.classList.add("text-red-500");
						localStorage.removeItem("whatsapp_phone");
					}
				};

				ws.onerror = error => {
					console.error("WebSocket error:", error);
					messageArea.textContent =
						"Connection to server failed. Please check your connection and try again.";
					messageArea.classList.add("text-red-500");
					localStorage.removeItem("whatsapp_phone");
				};

				ws.onclose = () => {
					console.log("WebSocket connection closed.");
				};
			});
		</script>
	</body>
</html>
