<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ConnectSphere - Chat</title>

		<!-- Tailwind CSS CDN -->
		<script src="https://cdn.tailwindcss.com"></script>

		<!-- Google Fonts: Fira Sans -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@400;500;700&display=swap"
			rel="stylesheet"
		/>

		<style>
			body {
				font-family: "Fira Sans", sans-serif;
			}
			.chat-container {
				max-height: 70vh;
				overflow-y: auto;
			}
			.message {
				max-width: 70%;
				margin: 0.5rem;
				padding: 0.5rem 1rem;
				border-radius: 0.75rem;
			}
			.sent {
				background-color: #e6f3fa;
				margin-left: auto;
			}
			.received {
				background-color: #f0f0f0;
			}
		</style>
	</head>
	<body class="bg-gray-50">
		<div class="flex flex-col items-center justify-center min-h-screen p-4">
			<div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6">
				<div class="flex justify-between items-center mb-4">
					<h1 class="text-2xl font-bold text-gray-800">Chat</h1>
					<button
						id="restart-button"
						class="py-2 px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 transition duration-150 ease-in-out"
					>
						Restart Connection
					</button>
				</div>

				<div
					id="chat-container"
					class="chat-container mb-4 p-4 bg-gray-100 rounded-lg"
				>
					<!-- Messages will be appended here -->
				</div>

				<form id="chat-form" class="flex gap-2">
					<input
						id="message-input"
						type="text"
						placeholder="Type a message..."
						class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
					/>
					<button
						type="submit"
						class="py-2 px-4 bg-teal-500 text-white rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-150 ease-in-out"
					>
						Send
					</button>
				</form>

				<div id="message-area" class="mt-4 text-sm text-gray-500"></div>
			</div>
		</div>

		<script>
			const phoneNumber = localStorage.getItem("whatsapp_phone");
			const messageArea = document.getElementById("message-area");
			const chatContainer = document.getElementById("chat-container");
			const chatForm = document.getElementById("chat-form");
			const messageInput = document.getElementById("message-input");
			const restartButton = document.getElementById("restart-button");

			if (!phoneNumber) {
				messageArea.textContent = "No active session. Please connect a device.";
				messageArea.classList.add("text-red-500");
				chatForm.classList.add("hidden");
				setTimeout(() => {
					window.location.href = "/";
				}, 2000);
			} else {
				const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
				const ws = new WebSocket(
					`${wsProtocol}//${window.location.host}/chat/${phoneNumber}`
				);

				ws.onopen = () => {
					ws.send(JSON.stringify({ type: "register", phone: phoneNumber }));
					messageArea.textContent = "Connected to chat server";
				};

				ws.onmessage = event => {
					try {
						const message = JSON.parse(event.data);
						switch (message.type) {
							case "message":
								const messageElement = document.createElement("div");
								messageElement.classList.add(
									"message",
									message.isSent ? "sent" : "received"
								);
								messageElement.textContent = message.text;
								chatContainer.appendChild(messageElement);
								chatContainer.scrollTop = chatContainer.scrollHeight;
								break;
							case "error":
								messageArea.textContent = message.message;
								messageArea.classList.add("text-red-500");
								localStorage.removeItem("whatsapp_phone");
								setTimeout(() => {
									window.location.href = "/";
								}, 2000);
								break;
							case "restarting":
							case "reconnecting":
								messageArea.textContent = message.message;
								break;
							case "connection-ready":
								messageArea.textContent = "Connection established";
								break;
						}
					} catch (error) {
						console.error("Failed to parse message:", error);
						messageArea.textContent = "Invalid message received";
						messageArea.classList.add("text-red-500");
					}
				};

				ws.onerror = error => {
					messageArea.textContent = "Chat server connection failed";
					messageArea.classList.add("text-red-500");
					localStorage.removeItem("whatsapp_phone");
					setTimeout(() => {
						window.location.href = "/";
					}, 2000);
				};

				ws.onclose = () => {
					messageArea.textContent = "Chat server connection closed";
					messageArea.classList.add("text-red-500");
				};

				chatForm.addEventListener("submit", event => {
					event.preventDefault();
					const text = messageInput.value.trim();
					if (text) {
						ws.send(
							JSON.stringify({
								type: "message",
								phone: phoneNumber,
								text,
							})
						);
						messageInput.value = "";
					}
				});

				restartButton.addEventListener("click", () => {
					ws.send(
						JSON.stringify({
							type: "restart",
							phone: phoneNumber,
						})
					);
					messageArea.textContent = "Restarting connection...";
				});
			}
		</script>
	</body>
</html>
